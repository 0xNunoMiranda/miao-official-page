---
deployment:
  tasks:
    # 1) Pasta de destino no servidor (ajusta para o teu utilizador cPanel)
    - export DEPLOYPATH=/home/miaotoke/apps/miao-official-page

    # 2) Garantir que a pasta de deploy existe
    - /bin/mkdir -p $DEPLOYPATH

    # 3) Instalar dependências (usa package-lock.json)
    - /bin/npm ci || /bin/npm install

    # 4) Build de produção (Next.js + TypeScript)
    - /bin/npm run build

    # 5) Copiar todos os arquivos da app para a pasta de deploy
    - /bin/rsync -aP --delete-after \
        --exclude ".git" \
        --exclude ".cpanel.yml" \
        ./ $DEPLOYPATH

    # 6) Reiniciar a app Node.js via Passenger (cPanel)
    - /bin/mkdir -p $DEPLOYPATH/tmp
    - /bin/touch $DEPLOYPATH/tmp/restart.txt

    # 7) Executar a app em Node.js via npm start
    - cd $DEPLOYPATH
    - /bin/npm run start &

    # 8) Mensagem final
    - echo "Deploy Next.js + TypeScript (TSX) concluído com sucesso!"
